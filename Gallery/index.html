<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Gallery - Anyone, Anytime, Anywhere</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.js" integrity="sha384-mjCisVk+9cQGYprByJbHxzwFO7BVEgR6iCftsCqnmHNKA8uzLYoRng5h1qKMvHjp" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/exifr/dist/lite.umd.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #000;
            color: #fff;
            line-height: 1.2;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 0;
            position: relative;
        }

        .site-title-top-left {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1em;
            font-weight: 300;
            line-height: 1.4;
            color: #fff;
        }

        .site-title-top-left a {
            color: #fff;
            text-decoration: none;
            transition: opacity 160ms ease;
        }

        .site-title-top-left a:hover {
            opacity: 0.8;
        }

        h1 {
            font-size: 2.0em;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.01em;
            line-height: 1.1;
            margin-top: 0;
            margin-bottom: 40px;
            padding-left: 40px;
            padding-right: 40px;
        }

        .banner {
            width: 100%;
            margin-top: 20px;
            margin-bottom: 0;
            padding: 0;
        }

        .banner-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            object-position: center 60%;
            display: block;
            margin: 0;
            padding: 0;
        }

        .photo-item {
            margin-bottom: 0;
            background-color: #151515;
            padding: 20px;
        }

        .photo-caption {
            margin-bottom: 0;
            margin-top: 0;
            font-size: 1em;
            color: #fff;
            font-weight: 300;
            line-height: 1.4;
            padding-bottom: 0;
            padding-top: 0;
        }

        .photo-item img {
            width: 100%;
            height: auto;
            display: block;
            margin: 0;
            padding: 0;
            vertical-align: bottom;
        }

        .photo-item-text {
            margin-top: 10px;
            font-size: 0.85em;
            color: #fff;
            font-weight: 300;
            line-height: 1.4;
        }

        #photo-gallery {
            display: flex;
            flex-direction: column;
            gap: 40px;
            padding-left: 100px;
            padding-right: 100px;
        }

        footer {
            display: none;
        }

        /* レスポンシブデザイン */
        @media (max-width: 767px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 2.5em;
                padding-left: 10px;
                padding-right: 10px;
            }

            .site-title-top-left {
                position: static;
                text-align: center;
                margin-bottom: 10px;
            }

            .banner-image {
                height: 100px;
            }

            #photo-gallery {
                padding-left: 10px;
                padding-right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="site-title-top-left" id="site-title-top-left"><a href="../index.html">Anyone, Anytime, Anywhere</a> / <span id="episode-name">Loading...</span></div>
    <div class="container">
        <header>
        </header>
    </div>
    <div class="banner">
        <img id="banner-image" src="" alt="Banner" class="banner-image" loading="lazy">
    </div>
    <div class="container">
        <h1 id="page-h1">Loading...</h1>

        <main id="photo-gallery">
            <!-- 画像はJavaScriptで動的に読み込まれます -->
        </main>
    </div>

    <script>
        // エピソード名を取得する関数
        function getEpisodeName() {
            // 1. URLパラメータから取得を試みる
            const urlParams = new URLSearchParams(window.location.search);
            const episodeParam = urlParams.get('episode');
            if (episodeParam) {
                return episodeParam.trim(); // スペースを削除
            }

            // 2. パスから取得を試みる
            const pathname = window.location.pathname;
            const href = window.location.href;
            
            // 例: /Blog/Gallery/EP0001_Ueno/index.html または /Gallery/EP0001_Ueno/
            // または file:///Users/.../Blog/Gallery/EP0001_Ueno/index.html
            const pathParts = pathname.split('/').filter(part => part);
            
            // Gallery/EP0001_Ueno/ の形式を探す
            const galleryIndex = pathParts.indexOf('Gallery');
            if (galleryIndex !== -1 && pathParts.length > galleryIndex + 1) {
                const episodeName = pathParts[galleryIndex + 1];
                // EP0001_ で始まるフォルダ名をチェック
                if (episodeName && episodeName.startsWith('EP')) {
                    return episodeName.trim(); // スペースを削除
                }
            }

            // 3. hrefから直接探す（file:// の場合）
            const hrefMatch = href.match(/Gallery\/(EP\d+_[^\/\s]+(?:\s+)?)/);
            if (hrefMatch) {
                return hrefMatch[1].trim(); // スペースを削除
            }

            return null;
        }

        // エピソード名を取得
        const episodeName = getEpisodeName();

        if (!episodeName) {
            document.body.innerHTML = '<div style="padding: 40px; text-align: center;"><h1>エピソードが見つかりません</h1><p><a href="../index.html" style="color: #fff;">トップページに戻る</a></p></div>';
        } else {
            // エピソード名の前後のスペースを削除（念のため）
            const episodeNameClean = episodeName.trim();
            // data.jsonを読み込む（パスにスペースが含まれる場合に備えてエンコード）
            const dataPath = `${episodeNameClean}/data.json`;
            
            fetch(dataPath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`data.jsonが見つかりません (Status: ${response.status}, Path: ${dataPath})`);
                    }
                    return response.json();
                })
                .then(data => {
                    // fullTitleがあればそれを使用、なければtitleを使用
                    const displayTitle = data.fullTitle || data.title;
                    
                    // エピソード番号を抽出（EP0001_Suikeien -> 1）
                    const episodeMatch = episodeNameClean.match(/EP(\d+)/);
                    const episodeNum = episodeMatch ? parseInt(episodeMatch[1]) : 0;
                    const episodeLabel = `Episode #${episodeNum}`;
                    
                    // ページタイトルを更新
                    document.getElementById('page-title').textContent = `${displayTitle} - Anyone, Anytime, Anywhere`;
                    
                    // エピソード名を更新（Episode #1形式）
                    document.getElementById('episode-name').textContent = episodeLabel;
                    
                    // h1を更新（fullTitleを使用）
                    document.getElementById('page-h1').textContent = displayTitle;
                    
                    // バナー画像を設定（banner.jpgが見つからない場合は最初の画像を使用）
                    const bannerImg = document.getElementById('banner-image');
                    if (bannerImg) {
                        setBannerImage(data, episodeNameClean, bannerImg);
                        
                        // バナー画像の縦方向の表示位置を設定
                        const bannerPosition = data.bannerPosition || '60%';
                        bannerImg.style.objectPosition = `center ${bannerPosition}`;
                    }
                    
                    // 画像を表示
                    loadImages(data, episodeNameClean);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    console.error('Error details:', {
                        message: error.message,
                        episodeName: episodeNameClean,
                        dataPath: dataPath,
                        currentPath: window.location.pathname,
                        currentHref: window.location.href
                    });
                    document.body.innerHTML = `<div style="padding: 40px; text-align: center;"><h1>データの読み込みに失敗しました</h1><p>${error.message}</p><p>エピソード: ${episodeNameClean}</p><p>パス: ${dataPath}</p><p style="font-size: 0.8em; color: #888;">ブラウザのコンソール（F12）で詳細を確認してください</p><p><a href="../index.html" style="color: #fff;">トップページに戻る</a></p></div>`;
                });
        }

        // バナー画像を設定する関数
        function setBannerImage(data, episodeName, bannerImg) {
            if (!bannerImg) {
                console.error('banner-image element not found');
                return;
            }
            
            let triedBannerJpeg = false;
            
            // banner.jpgを試す
            bannerImg.src = `${episodeName}/images/banner.jpg`;
            
            // banner.jpgが見つからない場合の処理
            bannerImg.onerror = function() {
                // banner.jpegも試す
                if (!triedBannerJpeg) {
                    triedBannerJpeg = true;
                    this.src = `${episodeName}/images/banner.jpeg`;
                    return;
                }
                
                // banner.jpegも見つからない場合、最初の画像を使用
                if (data.images && data.images.length > 0) {
                    const isStringArray = typeof data.images[0] === 'string';
                    
                    // banner.jpgとbanner.jpegを除外して最初の画像を取得
                    const filteredImages = data.images.filter(item => {
                        const fileName = (isStringArray ? item : item.file).toLowerCase();
                        return fileName !== 'banner.jpg' && fileName !== 'banner.jpeg';
                    });
                    
                    if (filteredImages.length > 0) {
                        const firstFilteredImage = filteredImages[0];
                        const firstFilteredFileName = isStringArray ? firstFilteredImage : firstFilteredImage.file;
                        const imagePath = `${episodeName}/images/${firstFilteredFileName}`;
                        this.src = imagePath;
                        // 最初の画像が見つからない場合のエラーハンドリングを無効化
                        this.onerror = null;
                    }
                }
            };
        }
        
        // 画像を表示する関数
        function loadImages(data, episodeName) {
            const gallery = document.getElementById('photo-gallery');
            
            if (!gallery) {
                console.error('photo-gallery element not found');
                return;
            }
            
            if (!data.images || data.images.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; padding: 40px;">画像がありません</p>';
                return;
            }
            
            // imagesが文字列配列かオブジェクト配列かを判定
            const isStringArray = typeof data.images[0] === 'string';
            
            // banner.jpgを除外して画像を表示
            const filteredImages = data.images.filter(item => {
                const fileName = (isStringArray ? item : item.file).toLowerCase();
                return fileName !== 'banner.jpg' && fileName !== 'banner.jpeg';
            });
            
            if (filteredImages.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; padding: 40px;">画像がありません</p>';
                return;
            }
            
            filteredImages.forEach((item) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                
                // 文字列配列の場合はそのまま、オブジェクト配列の場合はitem.fileを使用
                const fileName = isStringArray ? item : item.file;
                
                const img = document.createElement('img');
                const imagePath = `${episodeName}/images/${fileName}`;
                img.src = imagePath;
                img.alt = isStringArray ? '' : (item.description || '');
                img.loading = 'lazy';
                img.style.display = 'block';
                img.style.margin = '0';
                img.style.padding = '0';
                
                const text = document.createElement('div');
                text.className = 'photo-item-text';
                text.style.textAlign = 'right';
                text.style.display = 'flex';
                text.style.flexDirection = 'column';
                text.style.alignItems = 'flex-end';
                
                // 1行目: 撮影諸元
                const line1 = document.createElement('div');
                line1.style.textAlign = 'right';
                
                // 2行目: レンズ名（取得可能な場合）またはカメラ名と焦点距離
                const line2 = document.createElement('div');
                line2.style.textAlign = 'right';
                
                // 3行目: カメラ名と焦点距離（レンズ名がある場合のみ）
                const line3 = document.createElement('div');
                line3.style.textAlign = 'right';
                
                text.appendChild(line1);
                text.appendChild(line2);
                text.appendChild(line3);
                
                // 全画像のEXIF情報を取得
                if (typeof EXIF !== 'undefined') {
                    img.onload = async function() {
                        // exifrでレンズ名を取得（非同期）
                        let lensModelFromExifr = null;
                        if (typeof exifr !== 'undefined') {
                            try {
                                const response = await fetch(this.src);
                                const arrayBuffer = await response.arrayBuffer();
                                // pickオプションは配列形式で指定、またはオプションなしで全データを取得
                                const exifData = await exifr.parse(arrayBuffer);
                                lensModelFromExifr = exifData?.LensModel || exifData?.Lens || exifData?.LensInfo || exifData?.LensSpec || null;
                            } catch (error) {
                                // exifrで取得できない場合は無視（exif-jsにフォールバック）
                                console.debug('exifrでレンズ名を取得できませんでした:', error);
                            }
                        }
                        
                        // exif-jsでその他の情報を取得
                        EXIF.getData(this, function() {
                            const shutterSpeed = EXIF.getTag(this, "ExposureTime");
                            const aperture = EXIF.getTag(this, "FNumber");
                            const iso = EXIF.getTag(this, "ISOSpeedRatings");
                            const make = EXIF.getTag(this, "Make");
                            const model = EXIF.getTag(this, "Model");
                            const focalLength = EXIF.getTag(this, "FocalLength");
                            const lensModel = EXIF.getTag(this, "LensModel");
                            
                            // exifrで取得したレンズ名を優先、なければexif-jsの結果を使用
                            const finalLensModel = lensModelFromExifr || lensModel;
                            
                            // 1行目: 撮影諸元（英語表記）
                            const exifParts = [];
                            
                            // シャッター速度
                            if (shutterSpeed) {
                                const speed = shutterSpeed < 1 ? `1/${Math.round(1/shutterSpeed)}` : `${shutterSpeed}`;
                                exifParts.push(`Exposure ${speed}s`);
                            }
                            
                            // 絞り（f/4形式）
                            if (aperture) {
                                exifParts.push(`Aperture f/${Math.round(aperture)}`);
                            }
                            
                            // ISO
                            if (iso) {
                                exifParts.push(`ISO ${iso}`);
                            }
                            
                            if (exifParts.length > 0) {
                                line1.textContent = exifParts.join(' ');
                            } else {
                                line1.textContent = '';
                            }
                            
                            // レンズ名がある場合とない場合で表示を分ける
                            if (finalLensModel) {
                                // レンズ名がある場合: 2行目にレンズ名と焦点距離、3行目にカメラ名
                                const line2Parts = [];
                                line2Parts.push(finalLensModel);
                                
                                // 焦点距離（括弧内）
                                if (focalLength) {
                                    line2Parts.push(`(${Math.round(focalLength)}mm)`);
                                }
                                
                                if (line2Parts.length > 0) {
                                    line2.textContent = line2Parts.join(' ');
                                } else {
                                    line2.textContent = '';
                                }
                                
                                // 3行目: カメラ名
                                const line3Parts = [];
                                if (make && model) {
                                    line3Parts.push(`${make} ${model}`);
                                } else if (make) {
                                    line3Parts.push(make);
                                } else if (model) {
                                    line3Parts.push(model);
                                }
                                
                                if (line3Parts.length > 0) {
                                    line3.textContent = line3Parts.join(' ');
                                } else {
                                    line3.textContent = '';
                                }
                            } else {
                                // レンズ名がない場合: 2行目にカメラ名と焦点距離
                                const line2Parts = [];
                                // カメラ名
                                if (make && model) {
                                    line2Parts.push(`${make} ${model}`);
                                } else if (make) {
                                    line2Parts.push(make);
                                } else if (model) {
                                    line2Parts.push(model);
                                }
                                
                                // 焦点距離（括弧内）
                                if (focalLength) {
                                    line2Parts.push(`(${Math.round(focalLength)}mm)`);
                                }
                                
                                if (line2Parts.length > 0) {
                                    line2.textContent = line2Parts.join(' ');
                                } else {
                                    line2.textContent = '';
                                }
                                line3.textContent = '';
                            }
                        });
                    };
                } else {
                    // EXIF.jsが読み込まれていない場合
                    line1.textContent = '';
                    line2.textContent = isStringArray ? '' : (item.exifText || '');
                }
                
                photoItem.appendChild(img);
                photoItem.appendChild(text);
                gallery.appendChild(photoItem);
            });
            
            // 解説文を写真の最後に表示（写真と同じ幅）
            if (data.description && (data.description.en || data.description.ja)) {
                const descriptionItem = document.createElement('div');
                descriptionItem.className = 'photo-item';
                descriptionItem.style.paddingTop = '40px';
                descriptionItem.style.textAlign = 'left';
                
                const descriptionContent = document.createElement('div');
                descriptionContent.style.fontFamily = 'Georgia, "Times New Roman", serif';
                descriptionContent.style.fontStyle = 'italic';
                descriptionContent.style.fontSize = '0.95em';
                descriptionContent.style.lineHeight = '2';
                descriptionContent.style.color = '#fff';
                descriptionContent.style.fontWeight = '200';
                descriptionContent.style.letterSpacing = '0.02em';
                descriptionContent.style.textAlign = 'left';
                
                if (data.description.en) {
                    const enParagraph = document.createElement('p');
                    enParagraph.style.marginBottom = '0';
                    enParagraph.style.marginTop = '0';
                    enParagraph.style.textAlign = 'left';
                    // 配列の場合は結合、文字列の場合はそのまま使用（後方互換性）
                    enParagraph.textContent = Array.isArray(data.description.en) 
                        ? data.description.en.join(' ') 
                        : data.description.en;
                    descriptionContent.appendChild(enParagraph);
                    
                    // 日付を別行で表示（英語版：December 2025形式）
                    if (data.date) {
                        const dateParts = data.date.split('/');
                        if (dateParts.length >= 2) {
                            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                                           'July', 'August', 'September', 'October', 'November', 'December'];
                            const monthName = months[parseInt(dateParts[1]) - 1];
                            const year = dateParts[0];
                            
                            const dateElement = document.createElement('p');
                            dateElement.style.marginTop = '3px';
                            dateElement.style.marginBottom = '30px';
                            dateElement.style.fontSize = '0.85em';
                            dateElement.style.opacity = '0.7';
                            dateElement.style.fontStyle = 'normal';
                            dateElement.style.textAlign = 'right';
                            dateElement.textContent = `${monthName} ${year}`;
                            descriptionContent.appendChild(dateElement);
                        } else {
                            // 日付がない場合、英語版の段落に下マージンを設定
                            enParagraph.style.marginBottom = '30px';
                        }
                    } else {
                        enParagraph.style.marginBottom = '30px';
                    }
                }
                
                if (data.description.ja) {
                    const jaParagraph = document.createElement('p');
                    jaParagraph.style.marginBottom = '0';
                    jaParagraph.style.marginTop = '0';
                    jaParagraph.style.textAlign = 'left';
                    // 配列の場合は結合、文字列の場合はそのまま使用（後方互換性）
                    jaParagraph.textContent = Array.isArray(data.description.ja) 
                        ? data.description.ja.join(' ') 
                        : data.description.ja;
                    descriptionContent.appendChild(jaParagraph);
                    
                    // 日付を別行で表示（日本語版：2025年12月形式）
                    if (data.date) {
                        const dateParts = data.date.split('/');
                        if (dateParts.length >= 2) {
                            const dateElement = document.createElement('p');
                            dateElement.style.marginTop = '3px';
                            dateElement.style.marginBottom = '0';
                            dateElement.style.fontSize = '0.85em';
                            dateElement.style.opacity = '0.7';
                            dateElement.style.fontStyle = 'normal';
                            dateElement.style.textAlign = 'right';
                            dateElement.textContent = `${dateParts[0]}年${parseInt(dateParts[1])}月`;
                            descriptionContent.appendChild(dateElement);
                        }
                    }
                }
                
                descriptionItem.appendChild(descriptionContent);
                gallery.appendChild(descriptionItem);
            }
        }
    </script>
</body>
</html>
