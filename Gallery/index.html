<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Gallery - Anyone, Anytime, Anywhere</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #000;
            color: #fff;
            line-height: 1.2;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 0;
            position: relative;
        }

        .site-title-top-left {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1em;
            font-weight: 300;
            line-height: 1.4;
            color: #fff;
        }

        .site-title-top-left a {
            color: #fff;
            text-decoration: none;
            transition: opacity 160ms ease;
        }

        .site-title-top-left a:hover {
            opacity: 0.8;
        }

        h1 {
            font-size: 2.0em;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.01em;
            line-height: 1.1;
            margin-top: 0;
            margin-bottom: 40px;
            padding-left: 40px;
            padding-right: 40px;
        }

        .banner {
            width: 100%;
            margin-top: 20px;
            margin-bottom: 0;
            padding: 0;
        }

        .banner-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            object-position: center 60%;
            display: block;
            margin: 0;
            padding: 0;
        }

        .photo-item {
            margin-bottom: 0;
            background-color: #151515;
            padding: 20px;
        }

        .photo-caption {
            margin-bottom: 0;
            margin-top: 0;
            font-size: 1em;
            color: #fff;
            font-weight: 300;
            line-height: 1.4;
            padding-bottom: 0;
            padding-top: 0;
        }

        .photo-item img {
            width: 100%;
            height: auto;
            display: block;
            margin: 0;
            padding: 0;
            vertical-align: bottom;
        }

        .photo-item-text {
            margin-top: 20px;
            font-size: 1em;
            color: #fff;
            font-weight: 300;
            line-height: 1.4;
        }

        #photo-gallery {
            display: flex;
            flex-direction: column;
            gap: 40px;
            padding-left: 100px;
            padding-right: 100px;
        }

        footer {
            display: none;
        }

        /* レスポンシブデザイン */
        @media (max-width: 767px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 2.5em;
                padding-left: 10px;
                padding-right: 10px;
            }

            .site-title-top-left {
                position: static;
                text-align: center;
                margin-bottom: 10px;
            }

            .banner-image {
                height: 100px;
            }

            #photo-gallery {
                padding-left: 10px;
                padding-right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="site-title-top-left" id="site-title-top-left"><a href="../index.html">Anyone, Anytime, Anywhere</a> / <span id="episode-name">Loading...</span></div>
    <div class="container">
        <header>
        </header>
    </div>
    <div class="banner">
        <img id="banner-image" src="" alt="Banner" class="banner-image" loading="lazy">
    </div>
    <div class="container">
        <h1 id="page-h1">Loading...</h1>

        <main id="photo-gallery">
            <!-- 画像はJavaScriptで動的に読み込まれます -->
        </main>
    </div>

    <script>
        // エピソード名を取得する関数
        function getEpisodeName() {
            // 1. URLパラメータから取得を試みる
            const urlParams = new URLSearchParams(window.location.search);
            const episodeParam = urlParams.get('episode');
            if (episodeParam) {
                return episodeParam.trim(); // スペースを削除
            }

            // 2. パスから取得を試みる
            const pathname = window.location.pathname;
            const href = window.location.href;
            
            // デバッグ用（後で削除可能）
            console.log('Pathname:', pathname);
            console.log('Href:', href);
            
            // 例: /Blog/Gallery/EP0001_Ueno/index.html または /Gallery/EP0001_Ueno/
            // または file:///Users/.../Blog/Gallery/EP0001_Ueno/index.html
            const pathParts = pathname.split('/').filter(part => part);
            
            // Gallery/EP0001_Ueno/ の形式を探す
            const galleryIndex = pathParts.indexOf('Gallery');
            if (galleryIndex !== -1 && pathParts.length > galleryIndex + 1) {
                const episodeName = pathParts[galleryIndex + 1];
                // EP0001_ で始まるフォルダ名をチェック
                if (episodeName && episodeName.startsWith('EP')) {
                    return episodeName.trim(); // スペースを削除
                }
            }

            // 3. hrefから直接探す（file:// の場合）
            const hrefMatch = href.match(/Gallery\/(EP\d+_[^\/\s]+(?:\s+)?)/);
            if (hrefMatch) {
                return hrefMatch[1].trim(); // スペースを削除
            }

            return null;
        }

        // エピソード名を取得
        const episodeName = getEpisodeName();

        if (!episodeName) {
            document.body.innerHTML = '<div style="padding: 40px; text-align: center;"><h1>エピソードが見つかりません</h1><p><a href="../index.html" style="color: #fff;">トップページに戻る</a></p></div>';
        } else {
            // エピソード名の前後のスペースを削除（念のため）
            const episodeNameClean = episodeName.trim();
            // data.jsonを読み込む（パスにスペースが含まれる場合に備えてエンコード）
            const dataPath = `${episodeNameClean}/data.json`;
            console.log('Loading data from:', dataPath);
            console.log('Episode name:', episodeNameClean);
            
            fetch(dataPath)
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response URL:', response.url);
                    if (!response.ok) {
                        throw new Error(`data.jsonが見つかりません (Status: ${response.status}, Path: ${dataPath})`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data loaded successfully:', data);
                    // fullTitleがあればそれを使用、なければtitleを使用
                    const displayTitle = data.fullTitle || data.title;
                    
                    // エピソード番号を抽出（EP0001_Suikeien -> 1）
                    const episodeMatch = episodeNameClean.match(/EP(\d+)/);
                    const episodeNum = episodeMatch ? parseInt(episodeMatch[1]) : 0;
                    const episodeLabel = `Episode #${episodeNum}`;
                    
                    // ページタイトルを更新
                    document.getElementById('page-title').textContent = `${displayTitle} - Anyone, Anytime, Anywhere`;
                    
                    // エピソード名を更新（Episode #1形式）
                    document.getElementById('episode-name').textContent = episodeLabel;
                    
                    // h1を更新（fullTitleを使用）
                    document.getElementById('page-h1').textContent = displayTitle;
                    
                    // バナー画像を設定（banner.jpgが見つからない場合は最初の画像を使用）
                    const bannerImg = document.getElementById('banner-image');
                    setBannerImage(data, episodeNameClean, bannerImg);
                    
                    // バナー画像の縦方向の表示位置を設定
                    const bannerPosition = data.bannerPosition || '60%';
                    bannerImg.style.objectPosition = `center ${bannerPosition}`;
                    
                    // 画像を表示
                    loadImages(data, episodeNameClean);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    console.error('Error details:', {
                        message: error.message,
                        episodeName: episodeNameClean,
                        dataPath: dataPath,
                        currentPath: window.location.pathname,
                        currentHref: window.location.href
                    });
                    document.body.innerHTML = `<div style="padding: 40px; text-align: center;"><h1>データの読み込みに失敗しました</h1><p>${error.message}</p><p>エピソード: ${episodeNameClean}</p><p>パス: ${dataPath}</p><p style="font-size: 0.8em; color: #888;">ブラウザのコンソール（F12）で詳細を確認してください</p><p><a href="../index.html" style="color: #fff;">トップページに戻る</a></p></div>`;
                });
        }

        // バナー画像を設定する関数
        function setBannerImage(data, episodeName, bannerImg) {
            let triedBannerJpeg = false;
            
            // EP0004_MaedaとEP0005_Fushimiの場合はimages/フォルダがないため、banner.JPGを試す
            if (episodeName === 'EP0004_Maeda' || episodeName === 'EP0005_Fushimi') {
                bannerImg.src = `${episodeName}/banner.JPG`;
                bannerImg.onerror = function() {
                    // banner.JPGが見つからない場合、最初の画像を使用
                    if (data.images && data.images.length > 0) {
                        const isStringArray = typeof data.images[0] === 'string';
                        const firstImage = isStringArray ? data.images[0] : data.images[0].file;
                        this.src = `${episodeName}/${firstImage}`;
                        this.onerror = null; // 無限ループを防ぐ
                    }
                };
                return;
            }
            
            // banner.jpgを試す
            bannerImg.src = `${episodeName}/images/banner.jpg`;
            
            // banner.jpgが見つからない場合の処理
            bannerImg.onerror = function() {
                // banner.jpegも試す
                if (!triedBannerJpeg) {
                    triedBannerJpeg = true;
                    this.src = `${episodeName}/images/banner.jpeg`;
                    return;
                }
                
                // banner.jpegも見つからない場合、最初の画像を使用
                if (data.images && data.images.length > 0) {
                    const isStringArray = typeof data.images[0] === 'string';
                    
                    // banner.jpgとbanner.jpegを除外して最初の画像を取得
                    const filteredImages = data.images.filter(item => {
                        const fileName = (isStringArray ? item : item.file).toLowerCase();
                        return fileName !== 'banner.jpg' && fileName !== 'banner.jpeg';
                    });
                    
                    if (filteredImages.length > 0) {
                        const firstFilteredImage = filteredImages[0];
                        const firstFilteredFileName = isStringArray ? firstFilteredImage : firstFilteredImage.file;
                        // EP0004_MaedaとEP0005_Fushimiの場合はimages/フォルダがないため、パスを変更
                        const imagePath = (episodeName === 'EP0004_Maeda' || episodeName === 'EP0005_Fushimi')
                            ? `${episodeName}/${firstFilteredFileName}`
                            : `${episodeName}/images/${firstFilteredFileName}`;
                        this.src = imagePath;
                        // 最初の画像が見つからない場合のエラーハンドリングを無効化
                        this.onerror = null;
                    }
                }
            };
        }
        
        // 画像を表示する関数
        function loadImages(data, episodeName) {
            const gallery = document.getElementById('photo-gallery');
            
            if (!data.images || data.images.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; padding: 40px;">画像がありません</p>';
                return;
            }
            
            // imagesが文字列配列かオブジェクト配列かを判定
            const isStringArray = typeof data.images[0] === 'string';
            
            // banner.jpgを除外して画像を表示
            const filteredImages = data.images.filter(item => {
                const fileName = (isStringArray ? item : item.file).toLowerCase();
                return fileName !== 'banner.jpg' && fileName !== 'banner.jpeg';
            });
            
            if (filteredImages.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; padding: 40px;">画像がありません</p>';
                return;
            }
            
            filteredImages.forEach((item) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                
                // 文字列配列の場合はそのまま、オブジェクト配列の場合はitem.fileを使用
                const fileName = isStringArray ? item : item.file;
                
                const img = document.createElement('img');
                // EP0004_MaedaとEP0005_Fushimiの場合はimages/フォルダがないため、パスを動的に変更
                const imagePath = (episodeName === 'EP0004_Maeda' || episodeName === 'EP0005_Fushimi')
                    ? `${episodeName}/${fileName}`
                    : `${episodeName}/images/${fileName}`;
                img.src = imagePath;
                img.alt = isStringArray ? '' : (item.description || '');
                img.loading = 'lazy';
                img.style.display = 'block';
                img.style.margin = '0';
                img.style.padding = '0';
                
                // images/フォルダがない場合のフォールバック
                img.onerror = function() {
                    if (this.src.includes('/images/')) {
                        this.src = `${episodeName}/${fileName}`;
                        this.onerror = null; // 無限ループを防ぐ
                    }
                };
                
                const text = document.createElement('div');
                text.className = 'photo-item-text';
                text.textContent = ''; // 初期値は空
                
                // 全画像のEXIF情報を取得
                if (typeof EXIF !== 'undefined') {
                    img.onload = function() {
                        EXIF.getData(this, function() {
                            const shutterSpeed = EXIF.getTag(this, "ExposureTime");
                            const aperture = EXIF.getTag(this, "FNumber");
                            const iso = EXIF.getTag(this, "ISOSpeedRatings");
                            const make = EXIF.getTag(this, "Make");
                            const model = EXIF.getTag(this, "Model");
                            const focalLength = EXIF.getTag(this, "FocalLength");
                            
                            // 指定された形式でEXIF情報をフォーマット: f/3.6 1/20sISO800 (FUJIFILM X100VI / 23mm)
                            const exifParts = [];
                            
                            // 露出
                            if (aperture) {
                                exifParts.push(`f/${aperture}`);
                            }
                            
                            // シャッター速度
                            if (shutterSpeed) {
                                const speed = shutterSpeed < 1 ? `1/${Math.round(1/shutterSpeed)}` : `${shutterSpeed}`;
                                exifParts.push(`${speed}s`);
                            }
                            
                            // ISO
                            if (iso) {
                                exifParts.push(`ISO${iso}`);
                            }
                            
                            // カメラと焦点距離（括弧内）
                            const cameraParts = [];
                            if (make && model) {
                                cameraParts.push(`${make} ${model}`);
                            } else if (make) {
                                cameraParts.push(make);
                            } else if (model) {
                                cameraParts.push(model);
                            }
                            
                            if (focalLength) {
                                cameraParts.push(`${focalLength}mm`);
                            }
                            
                            if (cameraParts.length > 0) {
                                exifParts.push(`(${cameraParts.join(' / ')})`);
                            }
                            
                            if (exifParts.length > 0) {
                                text.textContent = exifParts.join(' ');
                            } else {
                                text.textContent = '';
                            }
                        });
                    };
                } else {
                    // EXIF.jsが読み込まれていない場合
                    text.textContent = isStringArray ? '' : (item.exifText || '');
                }
                
                photoItem.appendChild(img);
                photoItem.appendChild(text);
                gallery.appendChild(photoItem);
            });
            
            // 解説文を写真の最後に表示（写真と同じ幅）
            if (data.description && (data.description.en || data.description.ja)) {
                const descriptionItem = document.createElement('div');
                descriptionItem.className = 'photo-item';
                descriptionItem.style.paddingTop = '40px';
                descriptionItem.style.textAlign = 'center';
                
                const descriptionContent = document.createElement('div');
                descriptionContent.style.fontFamily = 'Georgia, "Times New Roman", serif';
                descriptionContent.style.fontStyle = 'italic';
                descriptionContent.style.fontSize = '0.95em';
                descriptionContent.style.lineHeight = '2';
                descriptionContent.style.color = '#fff';
                descriptionContent.style.fontWeight = '200';
                descriptionContent.style.letterSpacing = '0.02em';
                
                if (data.description.en) {
                    const enParagraph = document.createElement('p');
                    enParagraph.style.marginBottom = '30px';
                    enParagraph.style.marginTop = '0';
                    // 配列の場合は結合、文字列の場合はそのまま使用（後方互換性）
                    enParagraph.textContent = Array.isArray(data.description.en) 
                        ? data.description.en.join(' ') 
                        : data.description.en;
                    descriptionContent.appendChild(enParagraph);
                }
                
                if (data.description.ja) {
                    const jaParagraph = document.createElement('p');
                    jaParagraph.style.marginBottom = '0';
                    jaParagraph.style.marginTop = '0';
                    // 配列の場合は結合、文字列の場合はそのまま使用（後方互換性）
                    jaParagraph.textContent = Array.isArray(data.description.ja) 
                        ? data.description.ja.join(' ') 
                        : data.description.ja;
                    descriptionContent.appendChild(jaParagraph);
                }
                
                descriptionItem.appendChild(descriptionContent);
                gallery.appendChild(descriptionItem);
            }
        }
    </script>
</body>
</html>
